!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.lib=a.lib||{})}(this,function(a){"use strict";var b=L.Class.extend({data:null,next:null,prev:null,initialize:function(a){this.data=a},index:0}),c=L.Class.extend({_length:0,_head:null,_tail:null,_hash:{},_count:0,add:function(a){var c=new b(a);return 0==this._length?(this._head=c,this._tail=c):(this._tail.next=c,c.prev=this._tail,this._tail=c),this._length++,c.index=this._count,this._hash[this._count]=c,this._count++,this.resetPositions(),c},insertAfter:function(a,b){var c=this._head;if(!(0==this._length||b>this._length||b<0)&&null!==c){var d=this.get(b),e=this.get(b+1),f=this.add(a);this._tail=f.prev,delete this._tail.next,f.prev=d,f.next=e,d.next=f,e.prev=f;for(var g=f;b++<this._length-1;)g.index=b,g=g.next;return this.resetPositions(),f}},get:function(a){var c=this._head,d=this._length,e=0;if(0===d||a<0||a>d)return new b;for(;e<a;)c=c.next,e++;return c},getLast:function(){return this.get(this._length-1)},getFirst:function(){return this.get(0)},remove:function(a){if(a>-1&&a<this._length){var b=this._head,c=0;if(0===a)this._head=b.next,this._head?this._head.prev=null:this._tail=null;else if(a===this._length-1)b=this._tail,this._tail=b.prev,this._tail.next=null;else{for(;c++<a;)b=b.next;b.prev.next=b.next,b.next.prev=b.prev}this._length--;for(var d in this._hash)this._hash[d]===b&&delete this._hash[d];return this.resetPositions(),b.data}return null},isEmpty:function(){return 0===this._length},each:function(a){for(var b=this._head;null!==b;)null!==b&&a.call(this,b),b=b.next},resetPositions:function(){var a=0;this.each(function(b){b._position=a++})},_beforeClear:function(){},clear:function(){this._beforeClear(),this._length=0,this._head=null,this._tail=null,this._hash={},this._count=0}}),d=L.DivIcon.extend({options:{className:"ruler-icon",iconSize:new L.Point(10,10)}}),e=L.Polyline.extend({options:{color:"#4a4a4a",weight:2,clickable:!0}}),f=void 0,g=.3,h=L.Class.extend({initialize:function(a){this._map=a,this.rulerOptions=this._map.__dr._options,this.rulerOptions._updateTooltipDistance&&(this._updateTooltipDistance=this.rulerOptions._updateTooltipDistance),this.rulerOptions._createTooltip&&(this._createTooltip=this.rulerOptions._createTooltip),g=this.rulerOptions.cursorOffset||g,f=this._recalcZoom()},_layerPaintPath:null,_layerPaintTemp:null,markers:[],_points:[],_tooltip:[],_hoverMarker:null,_distance:0,isEmpty:function(a){return""===a||null===a||void 0===a||0===a.length},createMarker:function(a){var b=L.marker(a,{icon:new d(this.rulerOptions.iconOptions),draggable:!0,isDragging:!1,riseOnHover:!0}).addTo(this._layerPaint);return b.on("dragstart",this._onDragStartMarker.bind(this)),b.on("drag",this._onDragMarker.bind(this)),b.on("dragend",this._onDragEndMarker.bind(this)),b.on("click",this._onClickMarker.bind(this)),b},addMarker:function(a){var b=this.createMarker(a);return b.node=this.hash.add(b),this.markers.push(b),this._points.push(a),this.resetMarkersPositions(),b},removeMarker:function(a){var b=a.options.position;this._layerPaintPath.spliceLatLngs(b,1),this.hash.remove(b),this.hash.resetPositions(),this._layerPaint.removeLayer(a),0!==b&&(this._layerPaint.removeLayer(this._tooltip[b-1]),this._tooltip.splice(b-1,1)),0===b&&this._tooltip.length&&(this._layerPaint.removeLayer(this._tooltip[this._tooltip.length-1]),this._tooltip.pop()),this.markers.splice(b,1),this._points.splice(b,1),this.resetMarkersPositions(),this._resetTooltipPositions(),1===this.markers.length&&(this._tooltip=[],this._distance=0)},resetMarkersPositions:function(){var a=0;this.markers.forEach(function(b){b.options.position=a++})},addHoverMarker:function(a,b){a.target._map=a.target.__dr._map,this._hoverMarker=L.marker(a.latlng,{icon:new d(this.rulerOptions.iconOptions),draggable:!0,position:this.hash._length}).addTo(this._layerPaint),this._hoverMarker.isDragging=!1,this._hoverMarker.prevMarkerIndex=b,this._hoverMarker.on("dragstart",this._onDragStartHoverMarker.bind(this)),this._hoverMarker.on("drag",this._onDragHoverMarker.bind(this)),this._hoverMarker.on("dragend",this._onDragEndHoverMarker.bind(this)),this._hoverMarker.node=this.hash.insertAfter(this._hoverMarker,b)},removeHoverMarker:function(a){null!==this._hoverMarker.prevMarkerIndex&&this.hash.remove(this._hoverMarker.prevMarkerIndex+1),this._layerPaint.removeLayer(this._hoverMarker),this._hoverMarker=null},redrawHoverMarker:function(a,b){this._hoverMarker.setLatLng(a.latlng),b===this._hoverMarker.prevMarkerIndex||this._hoverMarker.isDragging||(this._hoverMarker.node=this.hash.insertAfter(this._hoverMarker,b),this._hoverMarker.prevMarkerIndex=b)},insertAfter:function(a,b){var c=this.createMarker(b._latlng),d=this._createTooltip(b._latlng);this._layerPaintPath.spliceLatLngs(a,0,b._latlng),d.addTo(this._layerPaint),this.hash.insertAfter(c,a),c.node=this.hash,this.markers.splice(a,0,c),this._tooltip.splice(a,0,d),this._points.splice(a,0,b._latlng),this.resetMarkersPositions()},get:function(){},getLast:function(){},getFirst:function(){},clear:function(){},_onDragStartMarker:function(a){a.target.options.isDragging=!0,this._points.splice(a.target.options.position,1,a.target._latlng)},_onDragMarker:function(a){this._layerPaintPath.spliceLatLngs(a.target.options.position,1,a.target._latlng)},_onDragEndMarker:function(a){a.target.options.isDragging=!1,this._points.splice(a.target.options.position,1,a.target._latlng),this._resetTooltipPositions()},_onDragStartHoverMarker:function(a){this._hoverMarker.isDragging=!0,this._layerPaintTemp||(this._layerPaintTemp=L.polyline([this.markers[this._hoverMarker.prevMarkerIndex]._latlng,a.target._latlng,this.markers[this._hoverMarker.prevMarkerIndex+1]._latlng],Object.assign({color:"black",weight:1.5,clickable:!1,dashArray:"6,3"},this.rulerOptions.paintLineOptions)).addTo(this._layerPaint))},_onDragHoverMarker:function(a){this._layerPaintTemp.spliceLatLngs(0,2,this.markers[this._hoverMarker.prevMarkerIndex]._latlng,a.target._latlng,this.markers[this._hoverMarker.prevMarkerIndex+1]._latlng)},_onDragEndHoverMarker:function(a){this._hoverMarker.isDragging=!1,this.insertAfter(this._hoverMarker.prevMarkerIndex+1,a.target),this._map=this._map.removeLayer(this._hoverMarker),this._map.removeLayer(this._layerPaintTemp),this._layerPaintTemp=null,this._hoverMarker=null,this._resetTooltipPositions()},_onClickMarker:function(a){var b=a.target;b._map.__dr.view.removeMarker(b)},__enabled:!1,_toggleMeasure:function(){this.__enabled=!this.__enabled,this.__enabled?this._startMeasuring():this._stopMeasuring()},_startMeasuring:function(){this._oldCursor=this._map._container.style.cursor,this._map._container.style.cursor="crosshair",this._doubleClickZoom=this._map.doubleClickZoom.enabled(),this._map.doubleClickZoom.disable(),L.DomEvent.on(this._map,"zoomend",this._zoomChanged,this).on(this._map,"mousemove",this._mouseMove,this).on(this._map,"click",this._mouseClick,this).on(document,"keydown",this._onKeyDown,this),this._layerPaint||(this._layerPaint=L.layerGroup().addTo(this._map)),this._points||(this._points=[])},_stopMeasuring:function(){this._map._container.style.cursor=this._oldCursor,L.DomEvent.off(document,"keydown",this._onKeyDown,this).off(this._map,"mousemove",this._mouseMove,this).off(this._map,"click",this._mouseClick,this),this._doubleClickZoom&&this._map.doubleClickZoom.enable(),this._layerPaint&&this._layerPaint.clearLayers(),this._restartPath()},_mouseMove:function(a){var b=this;if(a.latlng&&this._lastPoint){var c=void 0,d=void 0,e=void 0,g=f,h=f;if(this.markers.forEach(function(f,i){var j=L.point(a.latlng.lat,a.latlng.lng).distanceTo(L.point(b.markers[i]._latlng.lat,b.markers[i]._latlng.lng));j&&j<h?(e=b.markers[i],h=j):i!==b.markers.length-1&&(j=b._calcHoverMarkerCoordinates(a.latlng,b.markers[i],b.markers[i+1]),j&&j.distance&&j.distance<g&&(c=j.latlng,g=j.distance,d=i))}),!this.isEmpty(c)&&this.isEmpty(this.markers.find(function(a){return a.options.isDragging}))){var i=a;i.latlng=c,this.isEmpty(this._hoverMarker)?this.addHoverMarker(i,d):this.redrawHoverMarker(i,d)}else console.log("!this.isEmpty(this._hoverMarker)",this._hoverMarker&&!this._hoverMarker.isDragging),this._hoverMarker&&!this._hoverMarker.isDragging&&this.removeHoverMarker(a);if(this.rulerOptions.paintLineOptions&&(this._layerPaintPathTemp?this._layerPaintPathTemp.spliceLatLngs(0,2,this._lastPoint,a.latlng):this._layerPaintPathTemp=L.polyline([this._lastPoint,a.latlng],Object.assign({color:"black",weight:1.5,clickable:!1,dashArray:"6,3"},this.rulerOptions.paintLineOptions)).addTo(this._layerPaint),this._tooltip.length)){var j=c?L.latLng(c):a.latlng;if(this._updateTooltipPosition(this._tooltip[this._tooltip.length-1],j),!this._lastPoint.equals(j)){var k=j.distanceTo(this._lastPoint);this._updateTooltipDistance(this._tooltip[this._tooltip.length-1],this._distance+k,k)}}}},_mouseClick:function(a){if(a.latlng&&this.isEmpty(this._hoverMarker)){if(this.addMarker(a.latlng),this.markers.length>1&&this._addTooltip(a.latlng),this._lastPoint&&this._tooltip.length){this._updateTooltipPosition(this._tooltip[this._tooltip.length-1],a.latlng);var b=a.latlng.distanceTo(this._lastPoint);this._updateTooltipDistance(this._tooltip[this._tooltip.length-1],this._distance+b,b),this._distance+=b}this._lastPoint&&!this._layerPaintPath&&(this._layerPaintPath=new e([this._lastPoint],this.rulerOptions.lineOptions).addTo(this._layerPaint)),this._layerPaintPath&&this._layerPaintPath.addLatLng(a.latlng),this._lastPoint=a.latlng}},_recalcZoom:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._map.getZoom();return g*Math.pow(2,7-a)},_zoomChanged:function(){var a=this._map.getZoom();f=this._recalcZoom(a)},_restartPath:function(){this._distance=0,this._tooltip=[],this._lastCircle=void 0,this._lastPoint=void 0,this._layerPaintPath=void 0,this._layerPaintPathTemp=void 0,this.hash.clear(),this.markers=[],this._points=[]},_createTooltip:function(a){var b,c;return c=L.divIcon({className:"ruler-tooltip",iconAnchor:[-5,-5]}),b=L.marker(a,{icon:c,clickable:!1})},_addTooltip:function(a){var b=this._createTooltip(a);return this._tooltip.push(b),b.addTo(this._layerPaint),b},_updateTooltipPosition:function(a,b){a.setLatLng(b),a.update()},_updateTooltipDistance:function(a,b,c){var d=b,e=c,f='<div class="ruler-tooltip-total">'+d+" m</div>";e>0&&d!=e&&(f+='<div class="ruler-tooltip-difference">(+'+e+" m)</div>"),a._icon.innerHTML=f},_resetTooltipPositions:function(){var a=0;if(this._points.length&&this._tooltip.length)for(var b=0;b<this._points.length-1;b++){this._updateTooltipPosition(this._tooltip[b],this._points[b+1]);var c=this._points[b].distanceTo(this._points[b+1]);this._updateTooltipDistance(this._tooltip[b],a+c,c),a+=c}},_onKeyDown:function(a){27==a.keyCode&&(this._lastPoint?this._finishPath():this._toggleMeasure())},hash:new c,_calcHoverMarkerCoordinates:function(a,b,c){var d=a.lat,e=a.lng,g=b._latlng.lat,h=b._latlng.lng,i=c._latlng.lat,j=c._latlng.lng,k=L.point(g,h).distanceTo(L.point(i,j)),l=L.point(d,e).distanceTo(L.point(g,h)),m=L.point(d,e).distanceTo(L.point(i,j)),n=j-h,o=g-i,p=-g*j+i*h,q=L.point(n,o).distanceTo(L.point(0,0)),r=Math.abs((n*d+o*e+p)/q);if(l>=L.point(m,k).distanceTo(L.point(0,0))||m>=L.point(l,k).distanceTo(L.point(0,0)))return{latlng:null,distance:r};if(r<f){var s=((d-g)*(i-g)+(e-h)*(j-h))/(Math.pow(i-g,2)+Math.pow(j-h,2)),t=g-o*s,u=h+n*s;return{latlng:{lat:t,lng:u},distance:r}}}}),i={renderRuler:null,iconOptions:{draggable:!0},lastNodeOptions:{},lineOptions:{},paintLineOptions:!1};L.MapDistanceRuler=L.Class.extend({baseOptions:i,initialize:function(a){this._options=Object.assign({},this.baseOptions,a)},onAdd:function(a){this._map=a,this._map.__dr=this,this.view=new h(this._map)},onRemove:function(a){},view:null}),L.mapDistanceRuler=function(a){return new L.MapDistanceRuler(a)},Object.defineProperty(a,"__esModule",{value:!0})});
//# sourceMappingURL=build.min.js.map